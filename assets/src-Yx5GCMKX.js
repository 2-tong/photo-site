import{s as e}from"./rolldown-runtime-B6ubh40S.js";import{a as t,n,t as r}from"../vendor/1-aoytCc18.js";let i=function(e){return e[e.CREATE_TEXTURE=0]=`CREATE_TEXTURE`,e[e.IMAGE_LOADING=1]=`IMAGE_LOADING`,e}({});const a={step:.1,wheelDisabled:!1,touchPadDisabled:!1},o={step:.5,disabled:!1},s={step:2,disabled:!1,mode:`toggle`,animationTime:200},c={disabled:!1,velocityDisabled:!0},l={sizeX:0,sizeY:0,velocityAlignmentTime:.2},u={sensitivity:1,animationTime:.2};var d=n(),f=e(t(),1),p=e(r(),1),m=e=>{let t=(0,d.c)(21),{title:n,defaultExpanded:r,children:i}=e,[a,o]=(0,f.useState)(r===void 0?!1:r),s;t[0]===Symbol.for(`react.memo_cache_sentinel`)?(s={marginBottom:`8px`},t[0]=s):s=t[0];let c=a?`4px`:`0`,l;t[1]===c?l=t[2]:(l={display:`flex`,alignItems:`center`,cursor:`pointer`,padding:`2px 0`,borderBottom:`1px solid rgba(255, 255, 255, 0.2)`,marginBottom:c},t[1]=c,t[2]=l);let u;t[3]===a?u=t[4]:(u=()=>o(!a),t[3]=a,t[4]=u);let m=a?`rotate(90deg)`:`rotate(0deg)`,h;t[5]===m?h=t[6]:(h=(0,p.jsx)(`span`,{style:{marginRight:`6px`,fontSize:`10px`,transform:m,transition:`transform 0.2s ease`},children:`â–¶`}),t[5]=m,t[6]=h);let g;t[7]===Symbol.for(`react.memo_cache_sentinel`)?(g={fontWeight:`bold`,fontSize:`11px`},t[7]=g):g=t[7];let _;t[8]===n?_=t[9]:(_=(0,p.jsx)(`span`,{style:g,children:n}),t[8]=n,t[9]=_);let v;t[10]!==l||t[11]!==u||t[12]!==h||t[13]!==_?(v=(0,p.jsxs)(`div`,{style:l,onClick:u,children:[h,_]}),t[10]=l,t[11]=u,t[12]=h,t[13]=_,t[14]=v):v=t[14];let y;t[15]!==i||t[16]!==a?(y=a&&(0,p.jsx)(`div`,{style:{paddingLeft:`16px`,fontSize:`11px`},children:i}),t[15]=i,t[16]=a,t[17]=y):y=t[17];let b;return t[18]!==v||t[19]!==y?(b=(0,p.jsxs)(`div`,{style:s,children:[v,y]}),t[18]=v,t[19]=y,t[20]=b):b=t[20],b},h=e=>{let t=(0,d.c)(6),{color:n,label:r}=e,i;t[0]===Symbol.for(`react.memo_cache_sentinel`)?(i={display:`flex`,alignItems:`center`,gap:`4px`},t[0]=i):i=t[0];let a;t[1]===n?a=t[2]:(a=(0,p.jsx)(`span`,{style:{width:`6px`,height:`6px`,borderRadius:`50%`,backgroundColor:n,display:`inline-block`}}),t[1]=n,t[2]=a);let o;return t[3]!==r||t[4]!==a?(o=(0,p.jsxs)(`span`,{style:i,children:[a,r]}),t[3]=r,t[4]=a,t[5]=o):o=t[5],o},g=e=>{let t=(0,d.c)(23),{ref:n,outlineEnabled:r,onToggleOutline:i}=e,[a,o]=(0,f.useState)(null),[s,c]=(0,f.useState)(!1),l;t[0]===Symbol.for(`react.memo_cache_sentinel`)?(l=()=>({updateDebugInfo:e=>{o(e)}}),t[0]=l):l=t[0],(0,f.useImperativeHandle)(n,l);let u=v,g=y,_;t[1]===Symbol.for(`react.memo_cache_sentinel`)?(_=function(e){return e?(0,p.jsxs)(m,{title:`Tile System`,defaultExpanded:!1,children:[(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Cache Size:`}),(0,p.jsxs)(`span`,{children:[e.cacheSize,` / `,e.cacheLimit]})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Visible Tiles:`}),(0,p.jsx)(`span`,{children:e.visibleTiles})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Loading Tiles:`}),(0,p.jsx)(`span`,{children:e.loadingTiles})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Pending Requests:`}),(0,p.jsx)(`span`,{children:e.pendingRequests})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Tile Size:`}),(0,p.jsx)(`span`,{children:e.tileSize})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Max Tiles/Frame:`}),(0,p.jsx)(`span`,{children:e.maxTilesPerFrame})]}),(0,p.jsxs)(`div`,{style:{fontSize:`10px`,marginTop:4,opacity:.7},children:[(0,p.jsxs)(`div`,{children:[`Cache Keys: `,e.cacheKeys?.slice(0,3).join(`, `),e.cacheKeys?.length>3?` ...`:``]}),(0,p.jsxs)(`div`,{children:[`Visible Keys: `,e.visibleKeys?.slice(0,3).join(`, `),e.visibleKeys?.length>3?` ...`:``]}),(0,p.jsxs)(`div`,{children:[`Loading Keys: `,e.loadingKeys?.slice(0,3).join(`, `),e.loadingKeys?.length>3?` ...`:``]}),(0,p.jsxs)(`div`,{children:[`Pending Keys: `,e.pendingKeys?.slice(0,3).join(`, `),e.pendingKeys?.length>3?` ...`:``]})]})]}):null},t[1]=_):_=t[1];let S=_;if(!a)return null;let C=r===void 0?a.tileOutlinesEnabled??!1:r,w,T,E;t[2]===Symbol.for(`react.memo_cache_sentinel`)?(w={position:`absolute`,top:`10px`,left:`10px`,background:`rgba(0, 0, 0, 0.9)`,color:`white`,padding:`8px`,borderRadius:`6px`,fontSize:`11px`,fontFamily:`monospace`,lineHeight:`1.3`,pointerEvents:`auto`,zIndex:1e3,minWidth:`240px`,maxWidth:`300px`,backdropFilter:`blur(4px)`,border:`1px solid rgba(255, 255, 255, 0.1)`},T={display:`flex`,justifyContent:`space-between`,alignItems:`center`,marginBottom:`8px`,paddingBottom:`4px`,borderBottom:`1px solid rgba(255, 255, 255, 0.2)`},E=(0,p.jsx)(`span`,{style:{fontWeight:`bold`,fontSize:`12px`},children:`WebGL Debug`}),t[2]=w,t[3]=T,t[4]=E):(w=t[2],T=t[3],E=t[4]);let D;t[5]===Symbol.for(`react.memo_cache_sentinel`)?(D={background:`none`,border:`none`,color:`white`,cursor:`pointer`,fontSize:`10px`,padding:`2px 4px`,borderRadius:`2px`,opacity:.7},t[5]=D):D=t[5];let O;t[6]===s?O=t[7]:(O=()=>c(!s),t[6]=s,t[7]=O);let k=s?`ðŸ“ˆ`:`ðŸ“‰`,A;t[8]!==O||t[9]!==k?(A=(0,p.jsxs)(`div`,{style:T,children:[E,(0,p.jsx)(`button`,{type:`button`,style:D,onClick:O,onMouseEnter:b,onMouseLeave:x,children:k})]}),t[8]=O,t[9]=k,t[10]=A):A=t[10];let j;t[11]!==s||t[12]!==C||t[13]!==a||t[14]!==i?(j=!s&&(0,p.jsxs)(p.Fragment,{children:[i&&(0,p.jsx)(`div`,{style:{marginBottom:`8px`},children:(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Tile Outline:`}),(0,p.jsx)(`button`,{type:`button`,style:{background:C?`rgba(34, 197, 94, 0.25)`:`rgba(148, 163, 184, 0.25)`,border:`1px solid rgba(255, 255, 255, 0.2)`,color:`white`,cursor:`pointer`,fontSize:`10px`,padding:`2px 6px`,borderRadius:`3px`},onClick:()=>i(!C),children:C?`On`:`Off`})]})}),(0,p.jsxs)(`div`,{style:{marginBottom:`8px`},children:[(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Scale:`}),(0,p.jsx)(`span`,{children:a.scale.toFixed(2)})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`LOD:`}),(0,p.jsxs)(`span`,{children:[a.currentLOD,` / `,a.lodLevels-1]})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Quality:`}),(0,p.jsx)(h,{color:u(a.quality),label:a.quality})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Status:`}),(0,p.jsx)(h,{color:a.isLoading?`#fbbf24`:`#4ade80`,label:a.isLoading?`Loading`:`Ready`})]})]}),(0,p.jsxs)(m,{title:`Transform`,children:[(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Relative Scale:`}),(0,p.jsx)(`span`,{children:a.relativeScale.toFixed(3)})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Position:`}),(0,p.jsxs)(`span`,{children:[`(`,a.translateX.toFixed(0),`, `,a.translateY.toFixed(0),`)`]})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Fit Scale:`}),(0,p.jsx)(`span`,{children:a.fitToScreenScale.toFixed(3)})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Max Scale:`}),(0,p.jsx)(`span`,{children:a.effectiveMaxScale.toFixed(3)})]})]}),(0,p.jsxs)(m,{title:`Image Info`,children:[(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Canvas:`}),(0,p.jsxs)(`span`,{children:[a.canvasSize.width,`Ã—`,a.canvasSize.height]})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Image:`}),(0,p.jsxs)(`span`,{children:[a.imageSize.width,`Ã—`,a.imageSize.height]})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`DPR:`}),(0,p.jsx)(`span`,{children:window.devicePixelRatio||1})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Max Texture:`}),(0,p.jsx)(`span`,{children:a.maxTextureSize})]})]}),(0,p.jsxs)(m,{title:`Memory`,children:[(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Textures:`}),(0,p.jsxs)(`span`,{children:[a.memory.textures.toFixed(1),` MB`]})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Estimated:`}),(0,p.jsxs)(`span`,{children:[a.memory.estimated.toFixed(1),` MB`]})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Budget:`}),(0,p.jsxs)(`span`,{children:[a.memory.budget.toFixed(1),` MB`]})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Pressure:`}),(0,p.jsx)(h,{color:g(a.memory.pressure),label:`${a.memory.pressure.toFixed(1)}%`})]}),(0,p.jsxs)(`div`,{style:{display:`flex`,justifyContent:`space-between`},children:[(0,p.jsx)(`span`,{children:`Active LODs:`}),(0,p.jsxs)(`span`,{children:[a.memory.activeLODs,` / `,a.memory.maxConcurrentLODs]})]})]}),S(a.tileSystem)]}),t[11]=s,t[12]=C,t[13]=a,t[14]=i,t[15]=j):j=t[15];let M;t[16]!==s||t[17]!==a?(M=s&&(0,p.jsx)(`div`,{style:{fontSize:`10px`,opacity:.8},children:(0,p.jsxs)(`div`,{children:[`Scale: `,a.scale.toFixed(2),` | LOD: `,a.currentLOD,` |`,` `,(0,p.jsx)(h,{color:u(a.quality),label:a.quality})]})}),t[16]=s,t[17]=a,t[18]=M):M=t[18];let N;return t[19]!==j||t[20]!==M||t[21]!==A?(N=(0,p.jsxs)(`div`,{style:w,children:[A,j,M]}),t[19]=j,t[20]=M,t[21]=A,t[22]=N):N=t[22],N};g.displayName=`DebugInfo`;var _=g;function v(e){switch(e){case`high`:return`#4ade80`;case`medium`:return`#fbbf24`;case`low`:return`#f87171`;default:return`#94a3b8`}}function y(e){return e<50?`#4ade80`:e<80?`#fbbf24`:`#f87171`}function b(e){return e.currentTarget.style.opacity=`1`}function x(e){return e.currentTarget.style.opacity=`0.7`}var S=class{};function C(e,t,n){let r=e.createShader(t);if(e.shaderSource(r,n),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){let t=e.getShaderInfoLog(r);throw e.deleteShader(r),Error(`Shader compilation failed: ${t}`)}return r}var w=`// @ts-nocheck
/// <reference lib="webworker" />

let originalImage = null

const TILE_SIZE = 512 // Must be same as in WebGLImageViewerEngine.ts

// ç®€åŒ–çš„ LOD çº§åˆ«
const WORKER_SIMPLE_LOD_LEVELS = [
  { scale: 0.25 }, // æžä½Žè´¨é‡
  { scale: 0.5 }, // ä½Žè´¨é‡
  { scale: 1 }, // æ­£å¸¸è´¨é‡
  { scale: 2 }, // é«˜è´¨é‡
  { scale: 4 }, // è¶…é«˜è´¨é‡
]
/**
 *
 * @param {MessageEvent} e
 * @returns
 */
self.onmessage = async (e) => {
  const { type, payload } = e.data
  console.info('[Worker] Received message:', type, payload)

  switch (type) {
    case 'load-image': {
      const { url } = payload
      try {
        console.info('[Worker] Fetching image:', url)
        const response = await fetch(url, { mode: 'cors' })
        const blob = await response.blob()
        originalImage = await createImageBitmap(blob)

        console.info('[Worker] Image decoded, posting init-done')
        self.postMessage({ type: 'init-done' })

        // Create initial LOD texture
        const lodLevel = 1 // Initial LOD level
        const lodConfig = WORKER_SIMPLE_LOD_LEVELS[lodLevel]
        const finalWidth = Math.max(1, Math.round(originalImage.width * lodConfig.scale))
        const finalHeight = Math.max(1, Math.round(originalImage.height * lodConfig.scale))

        const initialLODBitmap = await createImageBitmap(originalImage, {
          resizeWidth: finalWidth,
          resizeHeight: finalHeight,
          resizeQuality: 'medium',
        })

        console.info('[Worker] Initial LOD created, posting image-loaded')
        self.postMessage(
          {
            type: 'image-loaded',
            payload: {
              imageBitmap: initialLODBitmap,
              imageWidth: originalImage.width,
              imageHeight: originalImage.height,
              lodLevel,
            },
          },
          [initialLODBitmap],
        )
      } catch (error) {
        console.error('[Worker] Error loading image:', error)
        self.postMessage({ type: 'load-error', payload: { error } })
      }
      break
    }
    case 'init': {
      originalImage = payload.imageBitmap
      self.postMessage({ type: 'init-done' })
      break
    }
    case 'create-tile': {
      if (!originalImage) {
        console.warn('Worker has not been initialized with an image.')
        return
      }

      const { x, y, lodLevel, lodConfig, imageWidth, imageHeight, key } = payload

      try {
        const { cols, rows } = getTileGridSize(imageWidth, imageHeight, lodLevel, lodConfig)

        // Calculate tile region in the original image
        const sourceWidth = imageWidth / cols
        const sourceHeight = imageHeight / rows // Assuming square tiles from a square grid on the image
        const sourceX = x * sourceWidth
        const sourceY = y * sourceHeight

        const actualSourceWidth = Math.min(sourceWidth, imageWidth - sourceX)
        const actualSourceHeight = Math.min(sourceHeight, imageHeight - sourceY)

        const targetWidth = Math.min(TILE_SIZE, Math.ceil(actualSourceWidth * lodConfig.scale))
        const targetHeight = Math.min(TILE_SIZE, Math.ceil(actualSourceHeight * lodConfig.scale))

        if (targetWidth <= 0 || targetHeight <= 0) {
          return
        }

        // Use OffscreenCanvas to draw the tile
        const canvas = new OffscreenCanvas(targetWidth, targetHeight)
        const ctx = canvas.getContext('2d')

        ctx.imageSmoothingEnabled = true
        ctx.imageSmoothingQuality = lodConfig.scale >= 1 ? 'high' : 'medium'

        ctx.drawImage(
          originalImage,
          sourceX,
          sourceY,
          actualSourceWidth,
          actualSourceHeight,
          0,
          0,
          targetWidth,
          targetHeight,
        )

        const imageBitmap = canvas.transferToImageBitmap()
        self.postMessage({ type: 'tile-created', payload: { key, imageBitmap, lodLevel } }, [imageBitmap])
      } catch (error) {
        console.error('Error creating tile in worker:', error)
        self.postMessage({ type: 'tile-error', payload: { key, error } })
      }
      break
    }
  }
}

/**
 *
 * @param {number} imageWidth
 * @param {number} imageHeight
 * @param {number} _lodLevel
 * @param {object} lodConfig
 * @returns
 */
function getTileGridSize(imageWidth, imageHeight, _lodLevel, lodConfig) {
  const scaledWidth = imageWidth * lodConfig.scale
  const scaledHeight = imageHeight * lodConfig.scale

  const cols = Math.ceil(scaledWidth / TILE_SIZE)
  const rows = Math.ceil(scaledHeight / TILE_SIZE)

  return { cols, rows }
}
`,T=512,E=4,D=32,O=[{scale:.25},{scale:.5},{scale:1},{scale:2},{scale:4}],k=class extends S{canvas;gl;program;texture=null;imageLoaded=!1;originalImageSrc=``;scale=1;translateX=0;translateY=0;imageWidth=0;imageHeight=0;canvasWidth=0;canvasHeight=0;devicePixelRatio=1;isDragging=!1;lastMouseX=0;lastMouseY=0;lastTouchDistance=0;lastDoubleClickTime=0;isOriginalSize=!1;lastTouchTime=0;lastTouchX=0;lastTouchY=0;isAnimating=!1;animationStartTime=0;animationDuration=300;startScale=1;targetScale=1;startTranslateX=0;startTranslateY=0;targetTranslateX=0;targetTranslateY=0;animationStartLOD=-1;currentLOD=1;lodTextures=new Map;config;onZoomChange;onImageCopied;onLoadingStateChange;onDebugUpdate;currentQuality=`unknown`;isLoadingTexture=!0;worker=null;textureWorkerInitialized=!1;positionBuffer=null;texCoordBuffer=null;tileOutlineBuffer=null;positionLocation=-1;texCoordLocation=-1;matrixLocation;imageLocation;renderModeLocation;solidColorLocation;tileOutlineEnabled=!1;boundHandleMouseDown;boundHandleMouseMove;boundHandleMouseUp;boundHandleWheel;boundHandleDoubleClick;boundHandleTouchStart;boundHandleTouchMove;boundHandleTouchEnd;boundResizeCanvas;tileCache=new Map;loadingTiles=new Map;pendingTileRequests=[];tileProcessingFrameId=null;currentVisibleTiles=new Set;lastViewportHash=``;loadImageResolve=null;loadImageReject=null;constructor(e,t,n){super(),this.canvas=e,this.config=t,this.onZoomChange=t.onZoomChange,this.onImageCopied=t.onImageCopied,this.onLoadingStateChange=t.onLoadingStateChange,this.onDebugUpdate=n;let r=e.getContext(`webgl`,{alpha:!0,premultipliedAlpha:!1,antialias:!0,powerPreference:`default`});if(!r)throw Error(`WebGL not supported`);this.gl=r,this.boundHandleMouseDown=e=>this.handleMouseDown(e),this.boundHandleMouseMove=e=>this.handleMouseMove(e),this.boundHandleMouseUp=()=>this.handleMouseUp(),this.boundHandleWheel=e=>this.handleWheel(e),this.boundHandleDoubleClick=e=>this.handleDoubleClick(e),this.boundHandleTouchStart=e=>this.handleTouchStart(e),this.boundHandleTouchMove=e=>this.handleTouchMove(e),this.boundHandleTouchEnd=e=>this.handleTouchEnd(e),this.boundResizeCanvas=()=>this.resizeCanvas(),this.setupCanvas(),this.initWebGL(),this.initWorker(),this.setupEventListeners(),this.isLoadingTexture=!1,this.notifyLoadingStateChange(!1)}resizeObserver=null;setupCanvas(){this.resizeCanvas(),window.addEventListener(`resize`,this.boundResizeCanvas),this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeObserver=new ResizeObserver(e=>{e[0].target===this.canvas&&this.boundResizeCanvas()}),this.resizeObserver.observe(this.canvas)}resizeCanvas(){let e=this.canvas.getBoundingClientRect();this.devicePixelRatio=window.devicePixelRatio||1,this.canvasWidth=e.width,this.canvasHeight=e.height;let t=Math.round(e.width*this.devicePixelRatio),n=Math.round(e.height*this.devicePixelRatio);this.canvas.width=t,this.canvas.height=n,this.gl.viewport(0,0,t,n),this.imageLoaded&&(this.constrainScaleAndPosition(),this.render(),this.notifyZoomChange())}initWebGL(){let{gl:e}=this,t=C(e,e.VERTEX_SHADER,`
  attribute vec2 a_position;
  attribute vec2 a_texCoord;
  
  uniform mat3 u_matrix;
  
  varying vec2 v_texCoord;
  
  void main() {
    vec3 position = u_matrix * vec3(a_position, 1.0);
    gl_Position = vec4(position.xy, 0, 1);
    v_texCoord = a_texCoord;
  }
`),n=C(e,e.FRAGMENT_SHADER,`
  precision mediump float;
  
  uniform sampler2D u_image;
  uniform int u_renderMode;
  uniform vec4 u_solidColor;
  varying vec2 v_texCoord;
  
  void main() {
    if (u_renderMode == 0) {
      gl_FragColor = texture2D(u_image, v_texCoord);
    } else {
      gl_FragColor = u_solidColor;
    }
  }
`);if(this.program=e.createProgram(),e.attachShader(this.program,t),e.attachShader(this.program,n),e.linkProgram(this.program),!e.getProgramParameter(this.program,e.LINK_STATUS))throw Error(`Program linking failed: ${e.getProgramInfoLog(this.program)}`);if(e.useProgram(this.program),this.positionLocation=e.getAttribLocation(this.program,`a_position`),this.texCoordLocation=e.getAttribLocation(this.program,`a_texCoord`),this.positionLocation===-1||this.texCoordLocation===-1)throw Error(`Failed to get attribute locations`);let r=e.getUniformLocation(this.program,`u_matrix`),i=e.getUniformLocation(this.program,`u_image`),a=e.getUniformLocation(this.program,`u_renderMode`),o=e.getUniformLocation(this.program,`u_solidColor`);if(!r||!i||!a||!o)throw Error(`Failed to get uniform locations`);this.matrixLocation=r,this.imageLocation=i,this.renderModeLocation=a,this.solidColorLocation=o,e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);let s=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),c=new Float32Array([0,1,1,1,0,0,0,0,1,1,1,0]),l=e.createBuffer();if(!l)throw Error(`Failed to create position buffer`);this.positionBuffer=l,e.bindBuffer(e.ARRAY_BUFFER,l),e.bufferData(e.ARRAY_BUFFER,s,e.STATIC_DRAW);let u=e.createBuffer();if(!u)throw Error(`Failed to create texCoord buffer`);this.texCoordBuffer=u,e.bindBuffer(e.ARRAY_BUFFER,u),e.bufferData(e.ARRAY_BUFFER,c,e.STATIC_DRAW);let d=new Float32Array([-1,-1,1,-1,1,1,-1,1]),f=e.createBuffer();if(!f)throw Error(`Failed to create outline buffer`);this.tileOutlineBuffer=f,e.bindBuffer(e.ARRAY_BUFFER,f),e.bufferData(e.ARRAY_BUFFER,d,e.STATIC_DRAW),e.enableVertexAttribArray(this.positionLocation),e.enableVertexAttribArray(this.texCoordLocation),this.bindQuadBuffers(),e.uniform1i(this.renderModeLocation,0)}bindQuadBuffers(){if(!this.positionBuffer||!this.texCoordBuffer)return;let{gl:e}=this;e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.vertexAttribPointer(this.positionLocation,2,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.texCoordBuffer),e.vertexAttribPointer(this.texCoordLocation,2,e.FLOAT,!1,0,0)}bindOutlineBuffer(){if(!this.tileOutlineBuffer)return;let{gl:e}=this;e.bindBuffer(e.ARRAY_BUFFER,this.tileOutlineBuffer),e.vertexAttribPointer(this.positionLocation,2,e.FLOAT,!1,0,0)}drawTileOutlines(e){if(!this.tileOutlineEnabled||e.length===0||!this.tileOutlineBuffer)return;let{gl:t}=this;t.uniform1i(this.renderModeLocation,1),t.uniform4f(this.solidColorLocation,1,.4,0,.7),this.bindOutlineBuffer(),t.lineWidth(1);for(let n of e)t.uniformMatrix3fv(this.matrixLocation,!1,n),t.drawArrays(t.LINE_LOOP,0,4);this.bindQuadBuffers(),t.uniform1i(this.renderModeLocation,0)}initWorker(){this.worker=new Worker(URL.createObjectURL(new Blob([w])),{name:`texture-worker`}),this.worker.onmessage=e=>{this.handleWorkerMessage(e)},this.worker.onerror=e=>{console.error(`[Worker] Error:`,e.message,e.error)}}handleWorkerMessage(e){let{type:t,payload:n}=e.data;if(t===`image-loaded`){let{imageBitmap:e,imageWidth:t,imageHeight:r,lodLevel:a}=n;try{(!this.imageWidth||!this.imageHeight)&&(this.imageWidth=t,this.imageHeight=r,this.setupInitialScaling()),this.notifyLoadingStateChange(!0,i.CREATE_TEXTURE);let n=this.createWebGLTexture(e);e.close(),n&&(this.cleanupLODTextures(),this.lodTextures.set(a,n),this.texture=n,this.currentLOD=a,this.currentQuality=O[a].scale>=2?`high`:O[a].scale>=1?`medium`:`low`),this.imageLoaded=!0,this.isLoadingTexture=!1,this.notifyLoadingStateChange(!1),this.render(),this.notifyZoomChange(),this.loadImageResolve&&this.loadImageResolve()}catch(e){this.loadImageReject&&this.loadImageReject(e)}return}if(t===`load-error`){this.isLoadingTexture=!1,this.notifyLoadingStateChange(!1),this.loadImageReject&&this.loadImageReject(Error(`Failed to load image in worker`));return}if(t===`init-done`){this.textureWorkerInitialized=!0,this.updateTileCache();return}if(t===`tile-created`){let{key:e,imageBitmap:t,lodLevel:r}=n,i=this.loadingTiles.get(e),a=this.tileCache.get(e);if(!this.currentVisibleTiles.has(e)){t.close(),i&&this.loadingTiles.delete(e);return}let o=this.createWebGLTexture(t);if(t.close(),o){let[t,n]=e.split(`-`).map(Number),s={x:t,y:n,lodLevel:r,texture:o,lastUsed:performance.now(),isLoading:!1,priority:i?i.priority:a?a.priority:0};this.tileCache.set(e,s),i&&this.loadingTiles.delete(e),this.currentVisibleTiles.has(e)&&this.render()}else i&&this.loadingTiles.delete(e)}else if(t===`tile-error`){let{key:e,error:t}=n;console.warn(`Worker failed to create tile: ${e}`,t),this.loadingTiles.delete(e)}}async loadImage(e,t,n){return this.originalImageSrc=e,this.isLoadingTexture=!0,this.notifyLoadingStateChange(!0,i.IMAGE_LOADING),t&&n&&(this.imageWidth=t,this.imageHeight=n,this.setupInitialScaling()),new Promise((t,n)=>{this.loadImageResolve=t,this.loadImageReject=n,console.info(`[Engine] Posting "load-image" to worker`,this.worker),this.worker?.postMessage({type:`load-image`,payload:{url:e}})})}setupInitialScaling(){this.config.centerOnInit?this.fitImageToScreen():this.scale=this.getFitToScreenScale()*this.config.initialScale}createWebGLTexture(e){let{gl:t}=this,n=t.createTexture();return n?(t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),n):null}cleanupLODTextures(){for(let e of this.lodTextures.values())this.gl.deleteTexture(e);this.lodTextures.clear()}selectOptimalLOD(){if(this.isAnimating&&this.animationStartLOD>-1)return this.animationStartLOD;if(!this.imageLoaded)return 1;let e=this.scale*this.devicePixelRatio;for(let[t,n]of O.entries())if(n.scale>=e)return t;return O.length-1}easeOutQuart(e){return 1-(1-e)**4}startAnimation(e,t,n,r){this.isAnimating=!0,this.animationStartTime=performance.now(),this.animationDuration=r||(this.config.smooth?300:0),this.startScale=this.scale,this.targetScale=e,this.startTranslateX=this.translateX,this.startTranslateY=this.translateY,this.targetTranslateX=t,this.targetTranslateY=n,this.animationStartLOD=this.selectOptimalLOD();let i=this.scale,a=this.translateX,o=this.translateY;this.scale=e,this.translateX=t,this.translateY=n,this.constrainImagePosition(),this.targetTranslateX=this.translateX,this.targetTranslateY=this.translateY,this.scale=i,this.translateX=a,this.translateY=o,this.animate()}animate(){if(!this.isAnimating)return;let e=performance.now()-this.animationStartTime,t=Math.min(e/this.animationDuration,1),n=this.config.smooth?this.easeOutQuart(t):t;this.scale=this.startScale+(this.targetScale-this.startScale)*n,this.translateX=this.startTranslateX+(this.targetTranslateX-this.startTranslateX)*n,this.translateY=this.startTranslateY+(this.targetTranslateY-this.startTranslateY)*n,this.render(),this.notifyZoomChange(),t<1?requestAnimationFrame(()=>this.animate()):(this.isAnimating=!1,this.animationStartLOD=-1,this.scale=this.targetScale,this.translateX=this.targetTranslateX,this.translateY=this.targetTranslateY,this.render(),this.notifyZoomChange(),this.updateTileCache())}fitImageToScreen(){let e=this.canvasWidth/this.imageWidth,t=this.canvasHeight/this.imageHeight;this.scale=Math.min(e,t)*this.config.initialScale,this.translateX=0,this.translateY=0,this.isOriginalSize=!1}createMatrix(){let e=this.imageWidth*this.scale/this.canvasWidth,t=this.imageHeight*this.scale/this.canvasHeight,n=this.translateX*2/this.canvasWidth,r=-(this.translateY*2)/this.canvasHeight;return new Float32Array([e,0,0,0,t,0,n,r,1])}getFitToScreenScale(){let e=this.canvasWidth/this.imageWidth,t=this.canvasHeight/this.imageHeight;return Math.min(e,t)}constrainImagePosition(){if(!this.config.limitToBounds)return;let e=this.getFitToScreenScale();if(this.scale<=e){this.translateX=0,this.translateY=0;return}let t=this.imageWidth*this.scale,n=this.imageHeight*this.scale,r=Math.max(0,(t-this.canvasWidth)/2),i=Math.max(0,(n-this.canvasHeight)/2);this.translateX=Math.max(-r,Math.min(r,this.translateX)),this.translateY=Math.max(-i,Math.min(i,this.translateY))}constrainScaleAndPosition(){let e=this.getFitToScreenScale(),t=e*this.config.minScale,n=e*this.config.maxScale,r=Math.max(n,1);this.scale<t?this.scale=t:this.scale>r&&(this.scale=r),this.constrainImagePosition()}getTileKey(e,t,n){return`${e}-${t}-${n}`}getTileGridSize(e){let t=O[e],n=this.imageWidth*t.scale,r=this.imageHeight*t.scale;return{cols:Math.ceil(n/T),rows:Math.ceil(r/T)}}calculateVisibleTiles(){if(!this.imageLoaded)return[];let e=this.selectOptimalLOD(),{cols:t,rows:n}=this.getTileGridSize(e),r=this.canvasWidth/2+this.translateX,i=this.canvasHeight/2+this.translateY,a=this.imageWidth*this.scale,o=this.imageHeight*this.scale,s=r-a/2,c=i-o/2,l=Math.max(0,-s/this.scale),u=Math.max(0,-c/this.scale),d=Math.min(this.imageWidth,(this.canvasWidth-s)/this.scale),f=Math.min(this.imageHeight,(this.canvasHeight-c)/this.scale),p=this.imageWidth/t,m=this.imageHeight/n,h=Math.max(0,Math.floor(l/p)-1),g=Math.min(t-1,Math.ceil(d/p)+1),_=Math.max(0,Math.floor(u/m)-1),v=Math.min(n-1,Math.ceil(f/m)+1),y=[],b=(l+d)/2,x=(u+f)/2;for(let t=_;t<=v;t++)for(let n=h;n<=g;n++){let r=(n+.5)*p,i=(t+.5)*m,a=Math.sqrt((r-b)**2+(i-x)**2);y.push({x:n,y:t,lodLevel:e,priority:a})}return y.sort((e,t)=>e.priority-t.priority),y}async updateTileCache(){let e=this.calculateVisibleTiles(),t=new Set,n=`${this.scale.toFixed(3)}-${this.translateX.toFixed(1)}-${this.translateY.toFixed(1)}`,r=n!==this.lastViewportHash;this.lastViewportHash=n;let i=!1;for(let n of e){let e=this.getTileKey(n.x,n.y,n.lodLevel);t.add(e);let r=this.pendingTileRequests.find(t=>t.key===e);if(!this.tileCache.has(e)&&!this.loadingTiles.has(e)&&!r)this.pendingTileRequests.push({key:e,priority:n.priority}),i=!0;else if(r)r.priority=Math.min(r.priority,n.priority);else if(this.tileCache.has(e)){let t=this.tileCache.get(e);t.lastUsed=performance.now()}}this.currentVisibleTiles=t,this.cleanupOldTiles(),(r||i||this.pendingTileRequests.length>0)&&this.processPendingTileRequests()}cleanupOldTiles(){let e=performance.now();if(this.tileCache.size>D){let e=Array.from(this.tileCache.entries()).filter(([e])=>!this.currentVisibleTiles.has(e)).sort(([,e],[,t])=>e.lastUsed-t.lastUsed).slice(0,this.tileCache.size-D+5);for(let[t,n]of e)n.texture&&this.gl.deleteTexture(n.texture),this.tileCache.delete(t)}for(let[t,n]of this.tileCache.entries())!this.currentVisibleTiles.has(t)&&e-n.lastUsed>3e4&&(n.texture&&this.gl.deleteTexture(n.texture),this.tileCache.delete(t))}processPendingTileRequests(){if(!this.worker||!this.textureWorkerInitialized)return;if(this.pendingTileRequests.length===0){this.tileProcessingFrameId!==null&&(cancelAnimationFrame(this.tileProcessingFrameId),this.tileProcessingFrameId=null);return}this.pendingTileRequests.sort((e,t)=>e.priority-t.priority);let e=Math.max(1,Math.ceil(this.pendingTileRequests.length/2)),t=Math.min(E,e),n=this.pendingTileRequests.splice(0,t);for(let e of n){let{key:t,priority:n}=e;if(this.loadingTiles.has(t)||this.tileCache.has(t))continue;this.loadingTiles.set(t,{priority:n});let[r,i,a]=t.split(`-`).map(Number),o=O[a];this.worker.postMessage({type:`create-tile`,payload:{x:r,y:i,lodLevel:a,lodConfig:o,imageWidth:this.imageWidth,imageHeight:this.imageHeight,key:t}})}this.pendingTileRequests.length>0&&this.tileProcessingFrameId===null&&(this.tileProcessingFrameId=requestAnimationFrame(()=>{this.tileProcessingFrameId=null,this.processPendingTileRequests()}))}render(){let{gl:e}=this;if(!this.positionBuffer||!this.texCoordBuffer)return;e.viewport(0,0,this.canvas.width,this.canvas.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),e.useProgram(this.program),this.bindQuadBuffers(),e.uniform1i(this.renderModeLocation,0),this.texture&&(e.uniformMatrix3fv(this.matrixLocation,!1,this.createMatrix()),e.uniform1i(this.imageLocation,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.drawArrays(e.TRIANGLES,0,6));let t=this.selectOptimalLOD(),n=[];for(let r of this.currentVisibleTiles){let i=this.tileCache.get(r);if(!i||!i.texture||i.lodLevel!==t)continue;let a=this.createTileMatrix(i.x,i.y,i.lodLevel);e.uniformMatrix3fv(this.matrixLocation,!1,a),e.uniform1i(this.imageLocation,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,i.texture),e.drawArrays(e.TRIANGLES,0,6),this.tileOutlineEnabled&&n.push(a)}this.drawTileOutlines(n),this.updateDebugInfo(),!this.isAnimating&&performance.now()-this.lastTileUpdateTime>100&&(this.lastTileUpdateTime=performance.now(),setTimeout(()=>this.updateTileCache(),0))}createTileMatrix(e,t,n){let{cols:r,rows:i}=this.getTileGridSize(n),a=this.imageWidth/r,o=this.imageHeight/i,s=e*a,c=t*o,l=Math.min(this.imageWidth,s+a),u=Math.min(this.imageHeight,c+o),d=l-s,f=u-c,p=s+d/2,m=c+f/2,h=p-this.imageWidth/2,g=m-this.imageHeight/2,_=this.canvasWidth/2+this.translateX+h*this.scale,v=this.canvasHeight/2+this.translateY+g*this.scale,y=d*this.scale,b=f*this.scale,x=y/this.canvasWidth,S=b/this.canvasHeight,C=_*2/this.canvasWidth-1,w=-(v*2/this.canvasHeight-1);return new Float32Array([x,0,0,0,S,0,C,w,1])}lastTileUpdateTime=0;zoomIn(e=!1){let t=this.canvasWidth/2,n=this.canvasHeight/2;this.zoomAt(t,n,1+this.config.wheel.step,e)}zoomOut(e=!1){let t=this.canvasWidth/2,n=this.canvasHeight/2;this.zoomAt(t,n,1-this.config.wheel.step,e)}resetView(){let e=this.getFitToScreenScale()*this.config.initialScale;this.startAnimation(e,0,0)}getScale(){return this.scale}setTileOutlineEnabled(e){this.tileOutlineEnabled=e,this.render()}isTileOutlineEnabled(){return this.tileOutlineEnabled}destroy(){window.removeEventListener(`resize`,this.boundResizeCanvas),this.canvas.removeEventListener(`mousedown`,this.boundHandleMouseDown),this.canvas.removeEventListener(`mousemove`,this.boundHandleMouseMove),this.canvas.removeEventListener(`mouseup`,this.boundHandleMouseUp),this.canvas.removeEventListener(`wheel`,this.boundHandleWheel),this.canvas.removeEventListener(`dblclick`,this.boundHandleDoubleClick),this.canvas.removeEventListener(`touchstart`,this.boundHandleTouchStart),this.canvas.removeEventListener(`touchmove`,this.boundHandleTouchMove),this.canvas.removeEventListener(`touchend`,this.boundHandleTouchEnd),this.cleanupLODTextures(),this.texture&&this.gl.deleteTexture(this.texture),this.positionBuffer&&=(this.gl.deleteBuffer(this.positionBuffer),null),this.texCoordBuffer&&=(this.gl.deleteBuffer(this.texCoordBuffer),null),this.tileOutlineBuffer&&=(this.gl.deleteBuffer(this.tileOutlineBuffer),null),this.program&&this.gl.deleteProgram(this.program),this.resizeObserver&&this.resizeObserver.disconnect(),this.tileProcessingFrameId!==null&&(cancelAnimationFrame(this.tileProcessingFrameId),this.tileProcessingFrameId=null),this.worker?.terminate()}updateDebugInfo(){if(!this.onDebugUpdate?.current)return;let e=this.getFitToScreenScale(),t=this.scale/e,n=e*this.config.maxScale,r=Math.max(n,1),i=this.tileCache.size*4+this.lodTextures.size*16,a={cacheSize:this.tileCache.size,visibleTiles:this.currentVisibleTiles.size,loadingTiles:this.loadingTiles.size,pendingRequests:this.pendingTileRequests.length,cacheLimit:D,maxTilesPerFrame:E,tileSize:T,cacheKeys:Array.from(this.tileCache.keys()),visibleKeys:Array.from(this.currentVisibleTiles),loadingKeys:Array.from(this.loadingTiles.keys()),pendingKeys:this.pendingTileRequests.map(e=>e.key)};this.onDebugUpdate.current({scale:this.scale,relativeScale:t,translateX:this.translateX,translateY:this.translateY,currentLOD:this.currentLOD,lodLevels:O.length,canvasSize:{width:this.canvasWidth,height:this.canvasHeight},imageSize:{width:this.imageWidth,height:this.imageHeight},fitToScreenScale:e,userMaxScale:n,effectiveMaxScale:r,originalSizeScale:1,renderCount:performance.now(),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),quality:this.currentQuality,isLoading:this.isLoadingTexture,memory:{textures:i,estimated:i,budget:256,pressure:i/256*100,activeLODs:this.lodTextures.size,maxConcurrentLODs:3,onDemandStrategy:!0},tileOutlinesEnabled:this.tileOutlineEnabled,tileSystem:a})}notifyZoomChange(){if(this.onZoomChange){let e=this.scale,t=this.getFitToScreenScale(),n=this.scale/t;this.onZoomChange(e,n)}}notifyLoadingStateChange(e,t,n){this.onLoadingStateChange&&this.onLoadingStateChange(e,t,n||this.currentQuality)}setupEventListeners(){this.canvas.addEventListener(`mousedown`,this.boundHandleMouseDown),this.canvas.addEventListener(`mousemove`,this.boundHandleMouseMove),this.canvas.addEventListener(`mouseup`,this.boundHandleMouseUp),this.canvas.addEventListener(`wheel`,this.boundHandleWheel),this.canvas.addEventListener(`dblclick`,this.boundHandleDoubleClick),this.canvas.addEventListener(`touchstart`,this.boundHandleTouchStart),this.canvas.addEventListener(`touchmove`,this.boundHandleTouchMove),this.canvas.addEventListener(`touchend`,this.boundHandleTouchEnd)}handleMouseDown(e){this.isAnimating&&(this.isAnimating=!1,this.animationStartLOD=-1),!this.config.panning.disabled&&(this.isDragging=!0,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY)}handleMouseMove(e){if(!this.isDragging||this.config.panning.disabled)return;let t=e.clientX-this.lastMouseX,n=e.clientY-this.lastMouseY;this.translateX+=t,this.translateY+=n,this.lastMouseX=e.clientX,this.lastMouseY=e.clientY,this.constrainImagePosition(),this.render()}handleMouseUp(){this.isDragging=!1}handleWheel(e){if(e.preventDefault(),this.config.wheel.wheelDisabled)return;this.isAnimating&&(this.isAnimating=!1,this.animationStartLOD=-1);let t=this.canvas.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top,i=e.deltaY>0?1-this.config.wheel.step:1+this.config.wheel.step;this.zoomAt(n,r,i)}handleDoubleClick(e){if(e.preventDefault(),this.config.doubleClick.disabled)return;let t=Date.now();if(t-this.lastDoubleClickTime<300)return;this.lastDoubleClickTime=t;let n=this.canvas.getBoundingClientRect(),r=e.clientX-n.left,i=e.clientY-n.top;this.performDoubleClickAction(r,i)}handleTouchStart(e){if(e.preventDefault(),this.isAnimating){this.isAnimating=!1,this.animationStartLOD=-1;return}if(e.touches.length===1&&!this.config.panning.disabled){let t=e.touches[0],n=Date.now();if(!this.config.doubleClick.disabled&&n-this.lastTouchTime<300&&Math.abs(t.clientX-this.lastTouchX)<50&&Math.abs(t.clientY-this.lastTouchY)<50){this.handleTouchDoubleTap(t.clientX,t.clientY),this.lastTouchTime=0;return}this.isDragging=!0,this.lastMouseX=t.clientX,this.lastMouseY=t.clientY,this.lastTouchTime=n,this.lastTouchX=t.clientX,this.lastTouchY=t.clientY}else if(e.touches.length===2&&!this.config.pinch.disabled){this.isDragging=!1;let t=e.touches[0],n=e.touches[1];this.lastTouchDistance=Math.sqrt((n.clientX-t.clientX)**2+(n.clientY-t.clientY)**2)}}handleTouchMove(e){if(e.preventDefault(),e.touches.length===1&&this.isDragging&&!this.config.panning.disabled){let t=e.touches[0].clientX-this.lastMouseX,n=e.touches[0].clientY-this.lastMouseY;this.translateX+=t,this.translateY+=n,this.lastMouseX=e.touches[0].clientX,this.lastMouseY=e.touches[0].clientY,this.constrainImagePosition(),this.render()}else if(e.touches.length===2&&!this.config.pinch.disabled){let t=e.touches[0],n=e.touches[1],r=Math.sqrt((n.clientX-t.clientX)**2+(n.clientY-t.clientY)**2);if(this.lastTouchDistance>0){let e=r/this.lastTouchDistance,i=(t.clientX+n.clientX)/2,a=(t.clientY+n.clientY)/2,o=this.canvas.getBoundingClientRect();this.zoomAt(i-o.left,a-o.top,e)}this.lastTouchDistance=r}}handleTouchEnd(e){this.isDragging=!1,this.lastTouchDistance=0}handleTouchDoubleTap(e,t){if(this.config.doubleClick.disabled)return;let n=this.canvas.getBoundingClientRect(),r=e-n.left,i=t-n.top;this.performDoubleClickAction(r,i)}performDoubleClickAction(e,t){if(this.isAnimating=!1,this.animationStartLOD=-1,this.config.doubleClick.mode===`toggle`){let n=this.getFitToScreenScale(),r=n*this.config.minScale,i=n*this.config.maxScale,a=Math.max(i,1);if(this.isOriginalSize){let i=Math.max(r,Math.min(a,n)),o=(e-this.canvasWidth/2-this.translateX)/this.scale,s=(t-this.canvasHeight/2-this.translateY)/this.scale,c=e-this.canvasWidth/2-o*i,l=t-this.canvasHeight/2-s*i;this.startAnimation(i,c,l,this.config.doubleClick.animationTime),this.isOriginalSize=!1}else{let n=Math.max(r,Math.min(a,1)),i=(e-this.canvasWidth/2-this.translateX)/this.scale,o=(t-this.canvasHeight/2-this.translateY)/this.scale,s=e-this.canvasWidth/2-i*n,c=t-this.canvasHeight/2-o*n;this.startAnimation(n,s,c,this.config.doubleClick.animationTime),this.isOriginalSize=!0}}else this.zoomAt(e,t,this.config.doubleClick.step,!0)}zoomAt(e,t,n,r=!1){let i=this.scale*n,a=this.getFitToScreenScale(),o=a*this.config.minScale,s=a*this.config.maxScale;if(!(i<o||i>Math.max(s,1)))if(r&&this.config.smooth){let n=(e-this.canvasWidth/2-this.translateX)/this.scale,r=(t-this.canvasHeight/2-this.translateY)/this.scale,a=e-this.canvasWidth/2-n*i,o=t-this.canvasHeight/2-r*i;this.startAnimation(i,a,o)}else{let n=(e-this.canvasWidth/2-this.translateX)/this.scale,r=(t-this.canvasHeight/2-this.translateY)/this.scale;this.scale=i,this.translateX=e-this.canvasWidth/2-n*this.scale,this.translateY=t-this.canvasHeight/2-r*this.scale,this.constrainImagePosition(),this.render(),this.notifyZoomChange()}}async copyOriginalImageToClipboard(){try{let e=await(await fetch(this.originalImageSrc)).blob();if(!navigator.clipboard||!navigator.clipboard.write){console.warn(`Clipboard API not supported`);return}let t=new ClipboardItem({[e.type]:e});await navigator.clipboard.write([t]),this.onImageCopied&&this.onImageCopied()}catch(e){console.error(`Failed to copy image to clipboard:`,e)}}};const A=({ref:e,src:t,className:n=``,width:r,height:i,initialScale:d=1,minScale:m=.1,maxScale:h=10,wheel:g=a,pinch:v=o,doubleClick:y=s,panning:b=c,limitToBounds:x=!0,centerOnInit:S=!0,smooth:C=!0,alignmentAnimation:w=l,velocityAnimation:T=u,onZoomChange:E,onImageCopied:D,onLoadingStateChange:O,debug:A=!1,...j})=>{let M=(0,f.useRef)(null),N=(0,f.useRef)(null),[P,F]=(0,f.useState)(!1),I=(0,f.useRef)((()=>{})),L=(0,f.useMemo)(()=>({src:t,className:n,width:r||0,height:i||0,initialScale:d,minScale:m,maxScale:h,wheel:{...a,...g},pinch:{...o,...v},doubleClick:{...s,...y},panning:{...c,...b},limitToBounds:x,centerOnInit:S,smooth:C,alignmentAnimation:{...l,...w},velocityAnimation:{...u,...T},onZoomChange:E||(()=>{}),onImageCopied:D||(()=>{}),onLoadingStateChange:O||(()=>{}),debug:A||!1}),[t,n,r,i,d,m,h,g,v,y,b,x,S,C,w,T,E,D,O,A]);(0,f.useImperativeHandle)(e,()=>({zoomIn:e=>N.current?.zoomIn(e),zoomOut:e=>N.current?.zoomOut(e),resetView:()=>N.current?.resetView(),getScale:()=>N.current?.getScale()||1})),(0,f.useEffect)(()=>{if(!M.current)return;let e=new k(M.current,L,A?I:void 0);try{let n=L.width>0?L.width:void 0,r=L.height>0?L.height:void 0;e.loadImage(t,n,r).catch(console.error),N.current=e,F(e.isTileOutlineEnabled())}catch(e){console.error(`Failed to initialize WebGL Image Viewer:`,e)}return()=>{e?.destroy(),N.current=null}},[t,L,A]);let R=(0,f.useCallback)(e=>{F(e),N.current?.setTileOutlineEnabled(e)},[F]);return(0,p.jsxs)(`div`,{...j,style:{position:`relative`,width:`100%`,height:`100%`,...j.style},children:[(0,p.jsx)(`canvas`,{ref:M,className:n,style:{display:`block`,width:`100%`,height:`100%`,touchAction:`none`,border:`none`,outline:`none`,margin:0,padding:0,imageRendering:`pixelated`}}),A&&(0,p.jsx)(_,{outlineEnabled:P,onToggleOutline:R,ref:e=>{e&&(I.current=e.updateDebugInfo)}})]})};A.displayName=`WebGLImageViewer`;export{i as n,A as t};